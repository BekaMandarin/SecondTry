<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер Файлов</title>
    <!--
      Библиотеки для DOCX -> PDF
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!--
      Библиотеки для PPTX -> PDF
      (pptxjs требует jquery и jszip)
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Используем cdnjs-версию pptxjs, так как она включает зависимости -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxjs/0.1.3/pptxjs.min.js"></script>

    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Скрытый контейнер для рендеринга.
         Мы будем менять его размеры в зависимости от задачи.
        */
        #html-output {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px; /* Ширина по умолчанию для DOCX */
            padding: 20px;
            background: white;
            color: black;
            height: auto;
        }
        
        /* pptxjs требует стилей для рендеринга */
        .slide {
            background-color: white;
            color: black;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Конвертер Файлов
        </h1>
        
        <!-- Выбор форматов -->
        <div class="flex gap-4 mb-6">
            <div class="w-1/2">
                <label for="from-format" class="block text-sm font-medium text-gray-700 mb-1">Из:</label>
                <select id="from-format" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="docx" selected>DOCX (.docx)</option>
                    <option value="pptx">PPTX (.pptx)</option>
                    <option value="ppt">PPT (.ppt)</option>
                    <option value="doc">DOC (.doc)</option>
                </select>
            </div>
            <div class="w-1/2">
                <label for="to-format" class="block text-sm font-medium text-gray-700 mb-1">В:</label>
                <select id="to-format" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="pdf" selected>PDF (.pdf)</option>
                </select>
            </div>
        </div>

        <p class="text-gray-600 text-center mb-6">
            Выберите файлы для конвертации.
        </p>

        <div class="mb-6">
            <input type="file" id="file-input" accept=".docx" multiple class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100
            "/>
        </div>

        <button id="convert-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50">
            Конвертировать
        </button>

        <!-- Статус и загрузчик -->
        <div id="status" class="text-center mt-6 h-16">
            <div id="loader-container" class="hidden flex justify-center items-center">
                <div id="loader"></div>
            </div>
            <p id="status-message" class="text-lg text-gray-700"></p>
        </div>
    </div>

    <!-- 
      Этот div скрыт. 
      Он будет служить "сценой" для рендеринга как DOCX, так и PPTX.
    -->
    <div id="html-output"></div>

    <script>
        // Инициализация jsPDF
        const { jsPDF } = window.jspdf;

        // Находим элементы DOM
        const fileInput = document.getElementById('file-input');
        const convertButton = document.getElementById('convert-button');
        const htmlOutput = document.getElementById('html-output');
        const loaderContainer = document.getElementById('loader-container');
        const statusMessage = document.getElementById('status-message');
        const fromFormatSelect = document.getElementById('from-format');
        const toFormatSelect = document.getElementById('to-format');

        // Обновляем 'accept' в зависимости от выбора
        fromFormatSelect.addEventListener('change', (e) => {
            const selectedFormat = e.target.value;
            if (selectedFormat === 'docx') {
                fileInput.accept = '.docx';
            } else if (selectedFormat === 'pptx') {
                fileInput.accept = '.pptx';
            } else if (selectedFormat === 'ppt') {
                fileInput.accept = '.ppt';
            } else if (selectedFormat === 'doc') {
                fileInput.accept = '.doc';
            } else {
                fileInput.accept = '*';
            }
        });

        // Обработчик клика по кнопке
        convertButton.addEventListener('click', async () => { // Делаем обработчик асинхронным
            
            // Получаем выбранные форматы
            const fromFormat = fromFormatSelect.value;
            const toFormat = toFormatSelect.value;

            const files = fileInput.files; // Получаем список всех файлов
            if (files.length === 0) {
                showStatus("Пожалуйста, сначала выберите файл(ы).", 'error');
                return;
            }
            
            // Блокируем кнопку и показываем загрузчик
            setLoading(true, "Начало обработки...");

            // Обрабатываем файлы последовательно один за другим
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                showStatus(`Обработка ${i + 1} из ${files.length}: ${file.name}`, 'loading');

                try {
                    // --- НОВАЯ ЛОГИКА МАРШРУТИЗАЦИИ ---
                    if (fromFormat === 'docx' && toFormat === 'pdf') {
                        await convertDocxToPdf(file);
                    } else if (fromFormat === 'pptx' && toFormat === 'pdf') {
                        await convertPptxToPdf(file);
                    } else if (fromFormat === 'ppt' || fromFormat === 'doc') {
                        // Специально перехватываем .ppt и .doc и выдаем ошибку
                        const formatName = fromFormat.toUpperCase();
                        const newFormat = (fromFormat === 'ppt') ? 'PPTX' : 'DOCX';
                        throw new Error(`Формат .${formatName} не поддерживается. Пожалуйста, откройте файл и сохраните его как .${newFormat}, затем попробуйте снова.`);
                    } else {
                        // Эта ветка теперь должна быть недостижима из-за UI
                        const errorMsg = `Конвертация из ${fromFormat.toUpperCase()} в ${toFormat.toUpperCase()} не поддерживается.`;
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    // Если один файл не удался, логируем ошибку, показываем ее и переходим к следующему
                    console.error(`Ошибка при конвертации ${file.name}:`, error);
                    showStatus(`Ошибка с файлом ${file.name}. Пропускаем.`, 'error');
                    // Небольшая пауза, чтобы пользователь мог увидеть ошибку
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            setLoading(false, "Все файлы обработаны.", 'success');
            // Сбрасываем стили сцены
            htmlOutput.innerHTML = '';
            htmlOutput.style.width = '800px';
            htmlOutput.style.height = 'auto';
        });

        /**
         * Вспомогательная функция для чтения файла как ArrayBuffer с использованием Promise.
         * @param {File} file - Файл для чтения.
         * @returns {Promise<ArrayBuffer>}
         */
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error("Ошибка чтения файла: " + e.target.error));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * Конвертирует ОДИН файл DOCX в PDF.
         * @param {File} file - Файл .docx для конвертации.
         */
        async function convertDocxToPdf(file) {
            // 1. Сбрасываем сцену
            htmlOutput.innerHTML = '';
            htmlOutput.style.width = '800px'; // Стандартная ширина для документа
            htmlOutput.style.height = 'auto';

            // 2. Чтение файла
            const arrayBuffer = await readFileAsArrayBuffer(file);

            // 3. Конвертируем DOCX в HTML
            const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
            htmlOutput.innerHTML = result.value;
            
            // 4. Рендерим HTML в canvas
            showStatus("Рендеринг в canvas...", 'loading');
            const canvas = await html2canvas(htmlOutput, {
                scale: 2,
                useCORS: true,
                logging: false
            });
            
            // 5. Создаем PDF (Портретный A4)
            showStatus("Создание PDF...", 'loading');
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;

            const finalDoc = new jsPDF('p', 'pt', 'a4');
            const a4Width = finalDoc.internal.pageSize.getWidth() - 20; // с отступами
            const a4Height = finalDoc.internal.pageSize.getHeight() - 20;
            
            const finalImgWidth = a4Width;
            const finalImgHeight = (a4Width * imgHeight) / imgWidth;
            
            let finalHeightLeft = finalImgHeight;
            let finalPosition = 0;

            // Добавляем первую страницу
            finalDoc.addImage(imgData, 'PNG', 10, 10, finalImgWidth, finalImgHeight);
            finalHeightLeft -= a4Height;

            // Добавляем новые страницы, пока весь контент не будет добавлен
            while (finalHeightLeft > 0) {
                finalPosition -= a4Height;
                finalDoc.addPage();
                finalDoc.addImage(imgData, 'PNG', 10, finalPosition, finalImgWidth, finalImgHeight);
                finalHeightLeft -= a4Height;
            }

            // 6. Сохраняем PDF
            const originalFilename = file.name.replace(/\.docx$/, '');
            finalDoc.save(`${originalFilename}.pdf`);
        }

        /**
         * Конвертирует ОДИН файл PPTX в PDF.
         * @param {File} file - Файл .pptx для конвертации.
         */
        async function convertPptxToPdf(file) {
            // 1. Сбрасываем и настраиваем сцену для PPTX (16:9)
            htmlOutput.innerHTML = '';
            htmlOutput.style.width = '960px'; // Соотношение 16:9
            htmlOutput.style.height = '540px'; // Соотношение 16:9

            // 2. Чтение файла
            const arrayBuffer = await readFileAsArrayBuffer(file);
            
            // 3. Рендеринг PPTX в HTML с помощью pptxjs
            // pptxjs - это jQuery плагин
            showStatus("Рендеринг PPTX в HTML... (может занять время)", 'loading');
            await new Promise((resolve, reject) => {
                $("#html-output").pptxjs({
                    file: arrayBuffer,
                    slideWidth: 960,
                    slideHeight: 540,
                    onDone: resolve,
                    onError: reject
                });
            });

            // pptxjs создает <div class="slide"> для каждого слайда
            const slides = htmlOutput.querySelectorAll('.slide');
            const numSlides = slides.length;
            if (numSlides === 0) throw new Error("Не удалось найти слайды в файле.");

            // 4. Создаем PDF (Альбомный A4)
            const finalDoc = new jsPDF('l', 'pt', 'a4'); // 'l' for landscape
            const a4Width = finalDoc.internal.pageSize.getWidth();
            const a4Height = finalDoc.internal.pageSize.getHeight();

            // 5. Цикл по каждому слайду, скриншот и добавление в PDF
            for (let i = 0; i < numSlides; i++) {
                showStatus(`Обработка слайда ${i + 1} из ${numSlides}...`, 'loading');
                const slideElement = slides[i];
                
                // Делаем скриншот ТОЛЬКО этого слайда
                const canvas = await html2canvas(slideElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // Добавляем изображение на всю страницу
                finalDoc.addImage(imgData, 'PNG', 0, 0, a4Width, a4Height);

                // Добавляем новую страницу, если это не последний слайд
                if (i < numSlides - 1) {
                    finalDoc.addPage();
                }
            }

            // 6. Сохраняем PDF
            const originalFilename = file.name.replace(/\.pptx$/, '');
            finalDoc.save(`${originalFilename}.pdf`);
        }


        // Вспомогательная функция для отображения статуса
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'text-lg '; // Сброс классов
            
            if (type === 'error') {
                statusMessage.classList.add('text-red-600');
            } else if (type === 'success') {
                statusMessage.classList.add('text-green-600');
            } else if (type === 'loading' && message) {
                 statusMessage.classList.add('text-gray-700');
            } else {
                // Не сбрасывать, если тип 'loading' и нет сообщения
            }
        }

        // Вспомогательная функция для управления состоянием загрузки
        function setLoading(isLoading, message) {
            if (isLoading) {
                convertButton.disabled = true;
                loaderContainer.classList.remove('hidden');
                if(message) showStatus(message, 'loading');
            } else {
                convertButton.disabled = false;
                loaderContainer.classList.add('hidden');
                if(message) showStatus(message, message.includes('Ошибка') ? 'error' : 'success');
            }
        }

    </script>
</body>
</html>
